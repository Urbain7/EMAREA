<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EM AREA - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --primary: #3b82f6; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: var(--card); padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #334155; }
        input { background: #334155; border: 1px solid #475569; color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; font-family: 'JetBrains Mono', monospace; }
        button { cursor: pointer; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: #2563eb; }

        /* DASHBOARD */
        #dashboard { display: none; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        
        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .stat-val { font-size: 1.8rem; font-weight: 800; margin: 10px 0 0; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .text-green { color: var(--success); } .text-blue { color: var(--primary); } .text-orange { color: var(--warning); }

        /* TABLE */
        .shops-table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        th { background: #0f172a; color: #94a3b8; font-weight: 600; }
        .shop-row:hover { background: #252f42; }
        
        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .bg-active { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .bg-pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .bg-inactive { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        /* ACTIONS */
        .actions { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 0.75rem; }
        .btn-edit { background: #475569; color: white; }
        .btn-wa { background: #25D366; color: white; text-decoration: none; display: inline-block; border-radius: 4px; padding: 5px 8px; }

        /* JSON EXPORT ZONE */
        .export-zone { margin-top: 40px; background: #000; padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        textarea { width: 100%; height: 300px; background: #1e293b; color: #a5b4fc; border: none; font-family: 'JetBrains Mono', monospace; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.85rem; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>üõ°Ô∏è Admin Access</h2>
            <p style="color:#94a3b8; margin-bottom:20px; font-size:0.9rem;">Zone s√©curis√©e EM AREA</p>
            <input type="password" id="password" placeholder="Mot de passe...">
            <button class="btn-primary" onclick="checkAuth()">ENTRER</button>
            <p id="error-msg" style="color:var(--danger); display:none; margin-top:10px; font-size:0.8rem;">Acc√®s Refus√©</p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="header">
            <h1>üöÄ Tour de Contr√¥le</h1>
            <button class="btn-sm btn-edit" onclick="generateJSON()">üíæ G√©n√©rer le JSON</button>
        </div>

        <!-- STATS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Revenu Mensuel (MRR)</div>
                <div class="stat-val text-green" id="mrr-val">0 F</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Boutiques Actives</div>
                <div class="stat-val text-blue" id="active-shops">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">En attente paiement</div>
                <div class="stat-val text-orange" id="pending-shops">0</div>
            </div>
        </div>

        <!-- LISTE -->
        <table class="shops-table">
            <thead>
                <tr>
                    <th>Boutique</th>
                    <th>Abo</th>
                    <th>Boost</th>
                    <th>Revenu/mois</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="shops-list"></tbody>
        </table>

        <!-- ZONE JSON -->
        <div class="export-zone" id="export-area" style="display:none;">
            <h3 style="margin-top:0;">üìù Code JSON √† copier</h3>
            <p style="color:#94a3b8; font-size:0.8rem;">Copie ce code et remplace le contenu de <b>shops.json</b> sur GitHub.</p>
            <button class="btn-primary btn-sm" onclick="copyJSON()">Copier tout</button>
            <textarea id="json-output"></textarea>
        </div>
    </div>

    <script>
        // HASH CORRECT SHA-256 pour "admin123"
        const SECRET_HASH = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9";
        let shopsData = [];

        // 1. S√âCURIT√â
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkAuth() {
            const input = document.getElementById('password').value;
            const hash = await sha256(input);
            if(hash === SECRET_HASH) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        // 2. CHARGEMENT
        async function loadData() {
            try {
                // On ajoute un timestamp pour √©viter le cache navigateur
                const res = await fetch('shops.json?t=' + new Date().getTime());
                shopsData = await res.json();
                renderTable();
                calcStats();
            } catch(e) { alert("Erreur chargement shops.json : assure-toi que le fichier existe."); }
        }

        // 3. AFFICHAGE
        function renderTable() {
            const tbody = document.getElementById('shops-list');
            tbody.innerHTML = '';
            
            shopsData.forEach((s, index) => {
                let statusClass = s.subscription === 'active' ? 'bg-active' : (s.subscription === 'pending' ? 'bg-pending' : 'bg-inactive');
                let income = (s.subscription === 'active' ? 5000 : 0) + (s.boost_level * 2000);
                
                tbody.innerHTML += `
                <tr class="shop-row">
                    <td>
                        <div style="font-weight:bold;">${s.name}</div>
                        <div style="font-size:0.75rem; color:#64748b;">${s.location}</div>
                    </td>
                    <td>
                        <select onchange="updateShop(${index}, 'subscription', this.value)" style="padding:5px; width:auto; margin:0; background:#0f172a; border:none;">
                            <option value="active" ${s.subscription==='active'?'selected':''}>‚úÖ Actif</option>
                            <option value="pending" ${s.subscription==='pending'?'selected':''}>‚è≥ Attente</option>
                            <option value="inactive" ${s.subscription==='inactive'?'selected':''}>‚ùå Coup√©</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateShop(${index}, 'boost_level', parseInt(this.value))" style="padding:5px; width:auto; margin:0; background:#0f172a; border:none;">
                            <option value="0" ${s.boost_level===0?'selected':''}>0 - Aucun</option>
                            <option value="1" ${s.boost_level===1?'selected':''}>1 - Pub (+2k)</option>
                            <option value="2" ${s.boost_level===2?'selected':''}>2 - Ultra (+4k)</option>
                        </select>
                    </td>
                    <td style="color:#22c55e; font-weight:bold;">${income.toLocaleString()} F</td>
                    <td>
                        <div class="actions">
                            <a href="https://wa.me/${s.owner_phone}" target="_blank" class="btn-wa">üìû Relancer</a>
                            <a href="${s.url}" target="_blank" class="btn-sm btn-edit" style="text-decoration:none;">Voir</a>
                        </div>
                    </td>
                </tr>`;
            });
        }

        // 4. LOGIQUE & CALCULS
        function updateShop(index, field, value) {
            shopsData[index][field] = value;
            calcStats();
            renderTable(); 
            document.getElementById('export-area').style.display = 'block';
            generateJSON(); 
        }

        function calcStats() {
            let active = 0, pending = 0, mrr = 0;
            
            shopsData.forEach(s => {
                if(s.subscription === 'active') {
                    active++;
                    mrr += 5000; // Loyer de base
                } else if (s.subscription === 'pending') {
                    pending++;
                }
                if(s.subscription === 'active') {
                    mrr += (s.boost_level * 2000); 
                }
            });

            document.getElementById('active-shops').innerText = active;
            document.getElementById('pending-shops').innerText = pending;
            document.getElementById('mrr-val').innerText = mrr.toLocaleString() + ' F';
        }

        // 5. EXPORT
        function generateJSON() {
            const json = JSON.stringify(shopsData, null, 2);
            document.getElementById('json-output').value = json;
            document.getElementById('export-area').style.display = 'block';
            document.getElementById('export-area').scrollIntoView({behavior: "smooth"});
        }

        function copyJSON() {
            const copyText = document.getElementById("json-output");
            copyText.select();
            document.execCommand("copy");
            alert("JSON copi√© ! Colle-le maintenant dans ton fichier shops.json sur GitHub.");
        }
    </script>
</body>
</html>
