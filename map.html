<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Test Carte - EM AREA</title>
    
    <!-- 1. STYLE BASIQUE INTEGRE -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* On met une bordure rouge temporaire pour prouver que la boite est l√† */
        #map {
            height: 60vh;
            min-height: 400px;
            width: 100%;
            background-color: #e5e5e5; /* Gris si la carte ne charge pas */
            border: 2px solid red; /* TEST VISUEL */
            border-radius: 12px;
            margin-top: 20px;
        }
    </style>

    <!-- 2. LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

    <header class="app-header">
        <a href="index.html" class="logo">EM <span>AREA</span></a>
        <span>TEST GPS</span>
    </header>

    <div class="container">
        <div class="hero" style="background:#333; color:white; padding:15px; border-radius:12px; margin-top:15px;">
            <p style="margin:0;">Si vous voyez un cadre rouge ci-dessous, le code fonctionne.</p>
            <button class="btn btn-primary" onclick="locateUser()" style="margin-top:10px;">üìç Me Localiser</button>
        </div>

        <!-- LA CARTE -->
        <div id="map"></div>
        
        <div id="status" style="margin-top:10px; color:blue;">Chargement...</div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">Accueil</a>
        <a href="map.html" class="nav-item active">Carte</a>
    </nav>

    <!-- 3. SCRIPTS LEAFLET -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- 4. SCRIPT DE CARTE INT√âGR√â (Pas de fichier externe) -->
    <script>
        // DONN√âES EN DUR (Pour √©viter le blocage du fichier JSON)
        const fakeShops = [
            { name: "Sandy'Shop", lat: 6.1866, lng: 1.1884, loc: "Ago√®" },
            { name: "Koffi Tech", lat: 6.1328, lng: 1.2246, loc: "D√©ckon" }
        ];

        let map, userPos, routingControl;

        // On lance la carte d√®s que la page est pr√™te
        window.addEventListener('load', () => {
            document.getElementById('status').innerText = "Initialisation carte...";
            initMap();
        });

        function initMap() {
            // Cr√©ation de la carte
            map = L.map('map').setView([6.172, 1.23], 13); // Lom√©

            // Tuiles (Fond de carte)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'EM AREA',
                maxZoom: 19
            }).addTo(map);

            document.getElementById('status').innerText = "Carte charg√©e !";

            // Ajout des marqueurs (Donn√©es en dur)
            fakeShops.forEach(shop => {
                const popup = `<b>${shop.name}</b><br>${shop.loc}<br>
                               <button onclick="drawRoute(${shop.lat}, ${shop.lng})">üèçÔ∏è Y aller</button>`;
                L.marker([shop.lat, shop.lng]).addTo(map).bindPopup(popup);
            });
            
            // Forcer l'affichage (Bug gris)
            setTimeout(() => { map.invalidateSize(); }, 500);
        }

        function locateUser() {
            if(!navigator.geolocation) return alert("Pas de GPS");
            document.getElementById('status').innerText = "Recherche GPS...";
            
            navigator.geolocation.getCurrentPosition(pos => {
                userPos = [pos.coords.latitude, pos.coords.longitude];
                map.setView(userPos, 14);
                L.marker(userPos).addTo(map).bindPopup("Vous").openPopup();
                document.getElementById('status').innerText = "Position trouv√©e !";
            }, () => alert("Activez le GPS"));
        }

        // Fonction simplifi√©e pour le test
        window.drawRoute = (lat, lng) => {
            if(!userPos) { locateUser(); return; }
            if(routingControl) map.removeControl(routingControl);
            
            if(L.Routing) {
                routingControl = L.Routing.control({
                    waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(lat, lng)],
                    routeWhileDragging: false, show: false,
                    createMarker: () => null
                }).addTo(map);
                map.closePopup();
            }
        }
    </script>
</body>
</html>
